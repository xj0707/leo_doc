### 前言 ###
最近遇到一个问题，rsu上传的视频，不能在chrome上不能播放？首先想到是视频是不是损坏了，结果下载下来本地可以播放，那就是线上不支持这类视频播放。那这类视频编码是什么呢？为什么不支持了？以下是我这次调研和整理。
### 生活中的视音频 ###
平时大家都会看电影，遇到喜欢的还会收藏，于是就会有如下图所示，一大堆五花八门的电影。
![图片一](./v1.jpg)
因为下载的来源不同，这些电影文件有不同的格式，用不同的后缀表示：avi，rmvb，mp4，flv，mkv等等。在这里需要注意的是，这些格式代表的是封装格式。何为封装格式？就是把视频数据和音频数据打包成一个文件的规范。仅仅靠看文件的后缀，很难能看出具体使用了什么视音频编码标准。这类涉及到两个概念，封装格式和编码标准，后面我们再细说。
### 视音频技术 ###
如果想查看一个视频文件采用的视音频技术:可以选择任意一款播放器，点击右键查看属性，就可以查看该视频文件采用的视音频技术了。
视音频技术主要包含以下几点：封装技术，视频压缩编码技术以及音频压缩编码技术。如果考虑到网络传输的话，还包括流媒体协议技术。
视频播放器播放一个互联网上的视频文件，需要经过以下几个步骤：解协议，解封装，解码视音频，视音频同步。如果播放本地文件则不需要解协议，为以下几个步骤：解封装，解码视音频，视音频同步。他们的过程如图所示。
![图片二](./v2.jpg)
-  解协议
解协议的作用，就是将流媒体协议的数据，解析为标准的相应的封装格式数据。  
- 解封装
解封装的作用，就是将输入的封装格式的数据，分离成为音频流压缩编码数据和视频流压缩编码数据。  
- 解码
解码的作用，就是将视频/音频压缩编码数据，解码成为非压缩的视频/音频原始数据。  
- 视音频同步
视音频同步的作用，就是根据解封装模块处理过程中获取到的参数信息，同步解码出来的视频和音频数据，并将视频音频数据送至系统的显卡和声卡播放出来。  
下面是几个视频参数对比的资源，是Wikipedia上的，总结的非常好有兴趣的可以去了解：
流媒体系统对比：
http://en.wikipedia.org/wiki/Comparison_of_streaming_media_systems
封装格式对比：
http://en.wikipedia.org/wiki/Comparison_of_container_formats
视频编码器对比：
http://en.wikipedia.org/wiki/Comparison_of_video_codecs
音频编码格式对比：
http://en.wikipedia.org/wiki/Comparison_of_audio_formats
视频播放器对比：
http://en.wikipedia.org/wiki/Comparison_of_video_player_software
原文链接：https://blog.csdn.net/leixiaohua1020/article/details/11842919
### 封装格式
封装格式的主要作用是把视频码流和音频码流按照一定的格式存储在一个文件中。
一个编码格式是对应着一个封装格式的，但一个封装格式对应着许多编码格式（渣男石锤了）
下面就是经由整理而出的封装格式一览
| 名称 | 流媒体 | 视频编码|
|---|---|---|
|AVI| 不支持 |MPEG-2,AC-1,H.264,DIVX,XVID|
|MP4| 支持| H.264,H.265,MPEG4...|
|WebM| 支持|VP8,VP9|
|RM/RMVB| 支持| RV,RM...|
|TS/PS|  支持 |MPEG-2,H.264,MPEG-4|
|MKV|支持|几乎所有视频编码格式|
从这里看比较优秀的封装格式就是MKV了。
### 视频编码
视频编码的主要作用是将视频像素数据（RGB，YUV等）压缩成为视频码流，从而降低视频的数据量。如果视频不经过压缩编码的话，体积通常是非常大的，一部电影可能就要上百G的空间。视频编码是视音频技术中最重要的技术之一。也是最复杂的技术。
**主要编码一览**

|名称| 推出机构 | 推出时间 |
|---| ---| ---|
|HEVC(H.265) |MPEG/ITU-T|2013|
|H.264 |MPEG/ITU-T|2003|
|MPEG4|MPEG|2001|
|MPEG2|MPEG|1994|
|VP9|Google|2013|
|VP8|Google|2008|
|VC-1|Microsoft Inc.|2006|
当前使用最多的视频编码方案就是H.264
注：H.264仅仅是一个编码标准，而不是一个具体的编码器，H.264只是给编码器的实现提供参照用的。
好了基本概念了解到这里，我们再来看看这个问题。
### html调查
目前网页在线播放是通过HTML5的`video`标签简单的在网页上插入一个视频链接来的。
一共支持三种格式： Ogg（音频格式）、MPEG4、WebM。但这三种格式对于浏览器的兼容性却各不同。如下：
|格式|    IE |    Firefox |     Opera|      Chrome |      Safari |
|---|---|--|--|--|--|
|Ogg    | No |    3.5+     |    10.5+ |     5.0+ |      No |
|MPEG4 | 9.0+ |     No   |    No     |   5.0+    |    3.0+ |
|WebM   | No    |  4.0+ |      10.6+  |   6.0+    |      No |

原文链接：https://blog.csdn.net/keji_123/article/details/77717849
从这里来只要是 这Ogg、MPEG4、WebM三种编码格式，chrome是能很好支持的，既然出现不能访问，那说明视频编码格式不是这三种。

### 解决方法
既然知道了问题出在哪，接下来就有两种解决方案了。
- 让视频的来源采用chrome可支持的编码方式，一切问题迎刃而解。（一般金主爸爸不听）
- 要想办法把现有的视频文件转码，转码成可支持的文件。（比如H.264）

于是经过进一步搜索，发现了ffmpeg这个神器，使用这个命令行的工具，最终可完成了视频编码的转换。
> Fmpeg 是领先的多媒体框架，能够解码、编码、转码、混合、解密、流媒体、过滤和播放人类和机器创造的几乎所有东西。   

ffmpeg的强大不是一两句都可以讲清楚，这里我们罗列几个常用的：
1. 视频转换格式----将test.avi格式的软件转换为test.mp4
	`ffmpeg -i test.avi test.mp4`
2. 视频截图保存为图片
    `ffmpeg -i inputfile.avi -r 1 -q:v 2 -f image2 image-%05d.jpg`
    -r:指定抽取的帧  即从视频中每秒抽取图片的数量 1代表每秒抽取一帧
    -f:保存图片使用的格式  可省略
    Image-%05d.jpg:指定文件的输出名字
3. 截取与合并视频
4. 给视频添加水印

详细请查看ffmpeg官网 http://www.ffmpeg.org/
当然我也发现一些问题：
- ffmpeg的执行包很大，远远超过了50M。部署的方式的从S3桶进行（针对与aws lambda函数来说）
- lambda执行时间是个问题，如果转码文件过大需要增加执行时间和内存（lambda 最大执行时间300s）

视频有两个概念

编码格式与封装格式
通常发现电影文件有不同的格式，用不同的后缀表示：avi，rmvb，mp4，flv，mkv等等
这些格式代表的是封装格式。
何为封装格式？就是把视频数据和音频数据打包成一个文件的规范。
一个编码格式是对应着一个封装格式的
但一个封装格式对应着许多编码格式（渣男石锤了）
下面就是经由整理而出的封装——编码格式对应表
MP4......H.264,H.265,MPEG4...
AVI......MPEG-2,AC-1,H.264,DIVX,XVID...
MOV......MPEG-2,XVID,H.264...
WMV......WMV,AC-1...
WebM......VP8,VP9
RM/RMVB......RV,RM...
TS/PS......MPEG-2,H.264,MPEG-4
MKV......所有视频编码格式

视音频技术主要包含以下几点：封装技术，视频压缩编码技术以及音频压缩编码技术。如果考虑到网络传输的话，还包括流媒体协议技术。

视频播放器播放一个互联网上的视频文件，需要经过以下几个步骤：解协议，解封装，解码视音频，视音频同步。如果播放本地文件则不需要解协议，为以下几个步骤：解封装，解码视音频，视音频同步

dvr_1 编码avc1
rsu_1 编码avc1
如果用lambda的话可以使用图层解决这个问题，但是lambda执行时间是个问题，如果文件过大需要加大执行时间和内存
如果是ec2就不存在，这个问题但是需要再ec2搭建开发环境（）

ffmpeg的执行包很大，远远超过了50M

所以，lambda函数的问题

其次s3触发，后会陷入死循环（文件写入，修改，再写入）



可以做哪些？

1、视频转换格式----将test.avi格式的软件转换为test.mp4

  ffmpeg -i test.avi test.mp4

2、视频截图保存为图片

  ffmpeg -i inputfile.avi -r 1 -q:v 2 -f image2 image-%05d.jpg

  -r:指定抽取的帧  即从视频中每秒抽取图片的数量 1代表每秒抽取一帧

  -f:保存图片使用的格式  可省略

  Image-%05d.jpg:指定文件的输出名字

3、截取与合并视频

4、给视频添加水印

经过调研

视频下载后，通过视频工具转码后，上传能播放

视频下载后，通过ffmpeg转码后，上传能播放

问题：转码时长和视频时长一致（PS:视频多长，转码多长，lambda目前支持最长时长15min,且内存需要加大）所以可能只能在ec2进行操作

其次s3触发器问题，（文件进入s3后）



！！！！调查各个浏览器对视频的支持（比如）

视频查找~~~


技术文章分享
chrome上视频不能播放调研 
http://182.151.214.170:1089/open.knowledge/view/1359



参考链接：https://blog.csdn.net/leixiaohua1020/article/details/18893769#comments
